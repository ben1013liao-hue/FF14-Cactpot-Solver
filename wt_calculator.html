<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FF14 å¤©æ›¸å¥‡è«‡æ©Ÿç‡è¨ˆç®—å™¨ï¼ˆEVç–ŠåŠ ä¿®æ­£ç‰ˆï¼‰</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'å¾®è»Ÿæ­£é»‘é«”', 'Noto Sans TC', sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #f0f0f0;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
    }

    h1 { margin: 0 0 5px 0; color: #d4af37; text-shadow: 2px 2px 4px #000; }
    .subtitle { color: #aaa; margin-bottom: 14px; font-size: 0.9em; }

    /* --- Layout --- */
    .main-container {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      gap: 30px;
      flex-wrap: wrap;
      max-width: 1280px;
      margin: 0 auto;
    }

    /* --- Left Nav --- */
    .nav-sidebar {
      display: flex;
      flex-direction: column;
      width: 200px;
      gap: 15px;
      padding-top: 55px;
      flex-shrink: 0;
    }
    .nav-item {
      display: flex;
      align-items: center;
      padding: 15px 20px;
      background-color: #2a2a4a;
      color: #ccc;
      text-decoration: none;
      border-radius: 10px;
      border: 1px solid #444;
      transition: all 0.3s ease;
      font-weight: bold;
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
    }
    .nav-item:hover {
      background-color: #3a3a5c;
      border-color: #d4af37;
      color: #fff;
      transform: translateX(5px);
    }
    .nav-item.active {
      background: linear-gradient(135deg, #d4af37 0%, #aa8a2a 100%);
      color: #000;
      border-color: #fff;
      box-shadow: 0 0 15px rgba(212, 175, 55, 0.4);
    }
    .nav-icon { margin-right: 10px; font-size: 20px; width: 24px; text-align: center; }

    /* --- Center Game Area --- */
    .game-area {
      background-color: #2a2a4a;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.5);
      max-width: 500px;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      border: 1px solid #444;
      position: relative;
    }

    .instructions {
      font-size: 0.95em;
      color: #ccc;
      margin-bottom: 16px;
      text-align: center;
      background: rgba(0,0,0,0.2);
      padding: 10px;
      border-radius: 8px;
      width: 100%;
      line-height: 1.45;
    }

    /* ç¶²æ ¼è¨­å®š */
    .grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-bottom: 18px;
    }
    .cell {
      width: 70px;
      height: 70px;
      background-color: #3a3a5c;
      border: 2px solid #555;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2em;
      transition: background-color 0.2s, border-color 0.2s;
      position: relative;
      user-select: none;
    }
    .cell:hover { background-color: #4a4a6c; border-color: #888; }
    
    .cell.active {
      background-color: #fdf5e6;
      border-color: #d4af37;
      box-shadow: 0 0 15px rgba(212, 175, 55, 0.6);
    }
    .cell.active::after {
      content: 'â˜…';
      color: #d4af37;
      font-size: 1.2em;
      filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3));
    }

    .controls {
      display: flex;
      justify-content: space-between;
      width: 100%;
      align-items: center;
      margin-bottom: 12px;
      padding: 0 10px;
    }
    .btn-reset {
      background-color: #c62828;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.2s;
    }
    .btn-reset:hover { background-color: #e53935; transform: scale(1.05); }

    /* çµæœé¢æ¿ */
    .results-panel {
      width: 100%;
      background-color: #222;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #777;
    }
    .result-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 6px 0;
      font-size: 1em;
      padding-bottom: 6px;
      border-bottom: 1px solid #333;
      color: #888;
    }
    .result-item:last-child { border-bottom: none; }
    
    .result-item.highlight-target {
      color: #fff;
      font-size: 1.2em;
      font-weight: bold;
      background: rgba(255, 255, 255, 0.05);
      padding: 8px;
      border-radius: 5px;
      border-bottom: none;
      margin: 10px 0;
      border: 1px solid #555;
    }
    
    .percent { font-family: monospace; font-size: 1.1em; }
    .chance-3 { color: #ffd700; }
    .chance-2 { color: #4a9fdf; text-shadow: 0 0 5px rgba(74, 159, 223, 0.5); }
    .chance-1 { color: #cd7f32; }

    .recommendation {
      margin-top: 14px;
      padding: 14px;
      text-align: center;
      font-weight: bold;
      font-size: 1.1em;
      border-radius: 10px;
      width: 100%;
      border: 2px solid transparent;
      line-height: 1.5;
    }
    .rec-keep-silver { 
      background: linear-gradient(135deg, rgba(74, 159, 223, 0.2), rgba(0,0,0,0)); 
      border-color: #4a9fdf; color: #fff; 
      box-shadow: 0 0 15px rgba(74, 159, 223, 0.1); 
    }
    .rec-shuffle { 
      background: rgba(198, 40, 40, 0.2); 
      border-color: #c62828; color: #ff8a80; 
    }
    .rec-wait { background-color: #444; color: #aaa; }

    /* --- Right Sidebar --- */
    .info-sidebar {
      width: 340px;
      display: flex;
      flex-direction: column;
      gap: 15px;
      padding-top: 55px;
    }
    .info-card {
      background-color: #2a2a4a;
      border: 1px solid #444;
      border-radius: 12px;
      padding: 18px;
    }
    .info-title {
      color: #d4af37;
      font-size: 1.1em;
      font-weight: bold;
      margin-bottom: 10px;
      border-bottom: 1px solid #555;
      padding-bottom: 6px;
    }
    .ev-head {
      display: flex; align-items: center; justify-content: space-between; gap: 12px;
    }
    .ev-value {
      font-size: 2em; font-weight: 900; color: #fff;
      font-family: monospace; margin: 5px 0;
    }
    .ev-hint { font-size: 0.9em; color: #ccc; margin-bottom: 10px; }
    
    .ev-formula {
      padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px;
      font-size: 0.85em; color: #aaa; line-height: 1.6;
    }
    .ev-formula strong { color: #fff; }

    .stat-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.95em; color: #ccc; }
    .stat-val { font-weight: bold; color: #fff; font-family: monospace; }
    .desc-text { font-size: 0.85em; color: #888; line-height: 1.4; }

    @media (max-width: 980px) {
      .nav-sidebar { width: 100%; flex-direction: row; padding-top: 0; margin-bottom: 10px; justify-content: center; }
      .nav-item { flex: 1; justify-content: center; }
      .info-sidebar { width: 100%; padding-top: 0; }
    }
    @media (max-width: 420px) {
      .cell { width: 60px; height: 60px; font-size: 1.5em; }
      .info-sidebar { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="main-container">

    <div class="nav-sidebar">
      <h3 style="text-align:center; color:#888; margin:0 0 10px 0; font-size:14px;">å·¥å…·åˆ—è¡¨</h3>
      <a href="index.html" class="nav-item">
        <span class="nav-icon">ğŸŒµ</span>
        <span>ä»™äººå¾®å½©</span>
      </a>
      <a href="#" class="nav-item active">
        <span class="nav-icon">ğŸ“–</span>
        <span>å¤©æ›¸å¥‡è«‡</span>
      </a>
    </div>

    <div class="game-area">
      <h1>å¤©æ›¸å¥‡è«‡æ¨¡æ“¬å™¨</h1>
      <div class="subtitle">éŠ€è³ï¼ˆ2æ¢ç·šï¼‰ç‰¹åŒ–ç­–ç•¥ç‰ˆ</div>

      <div class="instructions">
        è«‹é»é¸ç›®å‰çš„ <strong>7</strong> å€‹è²¼ç´™ä½ç½®ã€‚<br>ç³»çµ±å°‡æ¨¡æ“¬æ‰€æœ‰å¾ŒçºŒå¯èƒ½ï¼Œè¨ˆç®—æ˜¯å¦å€¼å¾—ä¿ç•™ã€‚
      </div>

      <div class="grid" id="grid"></div>

      <div class="controls">
        <span id="sticker-count" style="font-weight:bold; color:#d4af37;">å·²è²¼: 0 / 9</span>
        <button class="btn-reset" onclick="resetGrid()">é‡ç½®ç›¤é¢</button>
      </div>

      <div class="results-panel">
        <div class="result-item">
          <span class="chance-3">â˜… 3 æ¢é€£ç·š (é‡‘)</span>
          <span class="percent" id="prob-3">0%</span>
        </div>

        <div class="result-item highlight-target">
          <span class="chance-2">â˜… è‡³å°‘ 2 ç·š (éŠ€)</span>
          <span class="percent" id="prob-2">0%</span>
        </div>

        <div class="result-item">
          <span class="chance-1">â˜… è‡³å°‘ 1 ç·š (éŠ…)</span>
          <span class="percent" id="prob-1">0%</span>
        </div>
      </div>

      <div id="recommendation" class="recommendation rec-wait">è«‹æ”¾ç½®è²¼ç´™...</div>
    </div>

    <div class="info-sidebar">

      <div class="info-card" style="border-color: #4a9fdf;">
        <div class="info-title" style="color: #4a9fdf;">ğŸ“ˆ éŠ€è³ç­–ç•¥æœŸæœ›å€¼ (EV)</div>
        <div class="ev-head">
          <div class="ev-value" id="ev-value">â€”</div>
          <div style="text-align:right; font-size:0.8em; color:#888;">
            ç›®æ¨™ï¼š<span style="color:#4a9fdf; font-weight:bold;">éŠ€è³</span>
          </div>
        </div>
        <div class="ev-hint" id="ev-hint">éœ€å‰›å¥½è²¼æ»¿ 7 å¼µé¡¯ç¤ºå»ºè­°</div>

        <div class="ev-formula">
          <strong>å…¬å¼ä¿®æ­£ (ç–ŠåŠ åˆ¶)ï¼š</strong><br>
          EV = (é‡‘æ©Ÿç‡Ã—155 + éŠ€æ©Ÿç‡Ã—55 + éŠ…æ©Ÿç‡Ã—5)<br>
          <span style="font-size:0.8em; color:#666;">*å‡è¨­æ¬Šé‡ï¼šé‡‘100/éŠ€50/éŠ…5</span><br><br>
          <strong>åˆ¤è®€æ¨™æº–ï¼š</strong><br>
          â€¢ EV â‰¥ 20ï¼š<span style="color:#7fff7f;">å»ºè­°ä¿ç•™</span> (ç´„30%å‹ç‡)<br>
          â€¢ EV < 20ï¼šå»ºè­°æ´—ç‰Œ
        </div>
      </div>

      <div class="info-card">
        <div class="info-title">ğŸ“Š ç†è«–æ©Ÿç‡ (å‰›å¥½Nç·š)</div>
        <div class="desc-text" style="margin-bottom:10px;">
          æ­¤ç‚º 16 å– 9 çš„éœæ…‹æ•¸å­¸åˆ†ä½ˆ (æ´—ç‰Œ=å®Œå…¨éš¨æ©Ÿ)ã€‚
        </div>
        <div class="stat-row">
          <span class="chance-3">3 æ¢ç·š</span>
          <span class="stat-val">0.21%</span>
        </div>
        <div class="stat-row">
          <span class="chance-2">2 æ¢ç·š</span>
          <span class="stat-val">10.35%</span>
        </div>
        <div class="stat-row">
          <span class="chance-1">1 æ¢ç·š</span>
          <span class="stat-val">47.90%</span>
        </div>
        <div class="stat-row">
          <span>0 æ¢ç·š</span>
          <span class="stat-val">41.54%</span>
        </div>
      </div>

    </div>

  </div>

  <script>
    // === è¦å‰‡åƒæ•¸ ===
    const GRID_SIZE = 16;
    const MAX_STICKERS = 9;
    const MIN_ANALYZE = 7;

    // === ç­–ç•¥æ¬Šé‡ (Silver Focus + Cumulative) ===
    // å› ç‚ºç¾åœ¨çš„è¨ˆç®—æ–¹å¼æ”¹ç‚ºã€Œç–ŠåŠ ã€ï¼Œæ‰€ä»¥æ¬Šé‡æ•¸å€¼å¾®èª¿ä»¥ç¬¦åˆç›´è¦º
    // é‡‘ = 100, éŠ€ = 50, éŠ… = 5
    // 3æ¢ç·šç¸½åˆ† = 155
    // 2æ¢ç·šç¸½åˆ† = 55
    // 1æ¢ç·šç¸½åˆ† = 5
    const REWARD = { gold: 100, silver: 50, bronze: 5 };

    let gridState = new Array(GRID_SIZE).fill(0);

    const lines = [
      [0, 1, 2, 3], [4, 5, 6, 7], [8, 9, 10, 11], [12, 13, 14, 15],
      [0, 4, 8, 12], [1, 5, 9, 13], [2, 6, 10, 14], [3, 7, 11, 15],
      [0, 5, 10, 15], [3, 6, 9, 12]
    ];

    const gridElement = document.getElementById('grid');
    for (let i = 0; i < GRID_SIZE; i++) {
      const cell = document.createElement('div');
      cell.className = 'cell';
      cell.dataset.index = i;
      cell.onclick = () => toggleCell(i);
      gridElement.appendChild(cell);
    }

    function toggleCell(index) {
      const currentCount = gridState.filter(x => x === 1).length;
      if (gridState[index] === 0 && currentCount >= MAX_STICKERS) return;
      gridState[index] = gridState[index] === 0 ? 1 : 0;
      renderGrid();
      calculate();
    }

    function resetGrid() {
      gridState.fill(0);
      renderGrid();
      calculate();
    }

    function renderGrid() {
      const cells = document.querySelectorAll('.cell');
      let count = 0;
      cells.forEach((cell, i) => {
        if (gridState[i] === 1) {
          cell.classList.add('active');
          count++;
        } else {
          cell.classList.remove('active');
        }
      });
      document.getElementById('sticker-count').innerText = `å·²è²¼: ${count} / ${MAX_STICKERS}`;
    }

    function formatPercent(num) {
      if (num === 0) return '0%';
      if (num === 100) return '100%';
      return num.toFixed(2) + '%';
    }

    function countLines(grid) {
      let count = 0;
      for (const line of lines) {
        if (line.every(idx => grid[idx] === 1)) count++;
      }
      return count;
    }

    function getCombinations(array, k) {
      const result = [];
      function helper(start, combo) {
        if (combo.length === k) {
          result.push([...combo]);
          return;
        }
        for (let i = start; i < array.length; i++) {
          combo.push(array[i]);
          helper(i + 1, combo);
          combo.pop();
        }
      }
      helper(0, []);
      return result;
    }

    function setRecommendation(text, cls) {
      const el = document.getElementById('recommendation');
      el.innerHTML = text;
      el.className = `recommendation ${cls}`;
    }

    function calculate() {
      const currentStickers = gridState.filter(x => x === 1).length;

      let prob3 = 0, prob2 = 0, prob1 = 0;
      let evText = 'â€”';
      let evHint = 'è«‹è²¼æ»¿ 7 å¼µ';

      // 1. ä¸è¶³ 7 å¼µ
      if (currentStickers < MIN_ANALYZE) {
        setRecommendation(`è«‹ç¹¼çºŒè²¼è‡³ 7 å€‹è²¼ç´™<br><span style="font-size:0.8em; font-weight:normal">(é‚„å·® ${MIN_ANALYZE - currentStickers} å¼µ)</span>`, 'rec-wait');
        updatePanels(0, 0, 0, evText, evHint);
        return;
      }

      // 2. è¶…é 7 å¼µ
      if (currentStickers > MIN_ANALYZE) {
        const l = countLines(gridState);
        prob3 = l >= 3 ? 100 : 0;
        prob2 = l >= 2 ? 100 : 0;
        prob1 = l >= 1 ? 100 : 0;
        
        let finalText = "ä¸‹æ¬¡å†æ¥å†å²";
        if (l >= 3) finalText = "ğŸ‰ æ­å–œç²å¾—é‡‘è³ï¼";
        else if (l >= 2) finalText = "ğŸ‰ æ­å–œç²å¾—éŠ€è³ï¼";
        else if (l >= 1) finalText = "ç²å¾—éŠ…è³";

        setRecommendation(finalText, 'rec-wait');
        updatePanels(prob3, prob2, prob1, 'N/A', 'å·²è¶…éå¯æ´—ç‰Œéšæ®µ');
        return;
      }

      // 3. å‰›å¥½ 7 å¼µ
      const emptyIndices = gridState.map((val, idx) => val === 0 ? idx : -1).filter(idx => idx !== -1);
      const remainingStickers = MAX_STICKERS - currentStickers; 
      const combinations = getCombinations(emptyIndices, remainingStickers);
      const comboTotal = combinations.length;

      let count3 = 0, count2plus = 0, count1plus = 0;
      let totalEvPoints = 0;

      for (const combo of combinations) {
        const tempGrid = [...gridState];
        for (const idx of combo) tempGrid[idx] = 1;

        const l = countLines(tempGrid);
        
        // çµ±è¨ˆç²çæ©Ÿç‡ (At least)
        if (l >= 3) count3++;
        if (l >= 2) count2plus++;
        if (l >= 1) count1plus++;

        // çµ±è¨ˆ EV (ç–ŠåŠ åˆ¶ Cumulative)
        // 3ç·š = é‡‘+éŠ€+éŠ…, 2ç·š = éŠ€+éŠ…, 1ç·š = éŠ…
        let currentScore = 0;
        if (l >= 1) currentScore += REWARD.bronze;
        if (l >= 2) currentScore += REWARD.silver;
        if (l >= 3) currentScore += REWARD.gold;
        
        totalEvPoints += currentScore;
      }

      prob3 = (count3 / comboTotal) * 100;
      prob2 = (count2plus / comboTotal) * 100;
      prob1 = (count1plus / comboTotal) * 100;

      const evRaw = totalEvPoints / comboTotal;
      evText = evRaw.toFixed(1);

      // === æ±ºç­–é‚è¼¯ (EV Thresholds) ===
      // é›™è½ç‰Œ (41.67% 2ç·š): EV â‰ˆ 0.42 * 55 + 0.58 * 5 â‰ˆ 23 + 2.9 = 25.9
      // å–®è½ç‰Œ+é‹æ°£ (ç´„10-15% 2ç·š): EV â‰ˆ 0.15 * 55 + 0.85 * 5 â‰ˆ 8.25 + 4.25 = 12.5
      // 0è½ç‰Œ (2.7% 2ç·š): EV â‰ˆ 0.027 * 55 + 0.97 * 5 â‰ˆ 1.5 + 4.8 = 6.3
      
      let recText = "";
      let recClass = "";
      const goldText = prob3 > 0 ? "<br><span style='font-size:0.8em; color:#ffd700'>âœ¨ æœ‰é‡‘è³æ©Ÿæœƒ</span>" : "";

      if (evRaw >= 20) {
        recText = `âœ… å»ºè­°ä¿ç•™ï¼${goldText}`;
        recClass = "rec-keep-silver";
        evHint = "EVé«˜æ–¼20ï¼ŒéŠ€è³æ©Ÿç‡ä½³";
      } else if (evRaw >= 10) {
        recText = `ğŸ¤” å¯è€ƒæ…®ä¿ç•™${goldText}`;
        recClass = "rec-wait"; 
        evHint = "EVä»‹æ–¼10-20ï¼Œé¢¨éšªä¸­ç­‰";
      } else {
        recText = "ğŸ”„ å»ºè­°æ´—ç‰Œ";
        recClass = "rec-shuffle";
        evHint = "EVéä½ï¼Œå»ºè­°é‡ä¾†";
      }

      setRecommendation(recText, recClass);
      updatePanels(prob3, prob2, prob1, evText, evHint);
    }

    function updatePanels(p3, p2, p1, ev, hint) {
      document.getElementById('prob-3').innerText = formatPercent(p3);
      document.getElementById('prob-2').innerText = formatPercent(p2);
      document.getElementById('prob-1').innerText = formatPercent(p1);
      document.getElementById('ev-value').innerText = ev;
      document.getElementById('ev-hint').innerText = hint;
    }

    renderGrid();
    calculate();
  </script>
</body>
</html>